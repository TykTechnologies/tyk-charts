## Tyk Pump
Tyk Pump is a pluggable analytics purger to move Analytics generated by your Tyk nodes to any back-end.

[Overview of Tyk Pump](https://tyk.io/docs/tyk-pump/)

[More on pump configurations](https://github.com/TykTechnologies/tyk-pump/blob/master/README.md#pumps--back-ends-supported)

## Introduction
This chart deploys the open source Tyk pump on a [Kubernetes](https://kubernetes.io/) cluster using the [Helm](https://helm.sh/) package manager.

For typical usage, we recommend using following umbrella charts:
* For Tyk Open Source, please use [tyk-oss](https://github.com/TykTechnologies/tyk-charts/tree/main/tyk-oss)
* For Tyk Hybrid Gateway with Tyk Cloud or MDCB Remote Gateway, please use [tyk-mdcb-data-plane](https://github.com/TykTechnologies/tyk-charts/tree/main/tyk-mdcb-data-plane)
* Coming soon: For Tyk Self-Managed, please use [tyk-self-managed](https://github.com/TykTechnologies/tyk-charts/tree/main/)

[Learn more about different deployment options](https://tyk.io/docs/apim/)

## Prerequisites
* Kubernetes 1.19+
* Helm 3+
* [Redis](https://tyk.io/docs/planning-for-production/redis/)

## Installing the Chart
To install the chart from the Helm repository in namespace `tyk` with the release name `tyk-pump`:

    helm repo add tyk-helm https://helm.tyk.io/public/helm/charts/
    helm repo update
    helm show values tyk-helm/tyk-pump > values-pump.yaml --devel

Note: Set redis connection details first. See [Configuration](#configuration) below.

    helm install tyk-pump tyk-helm/tyk-pump -n tyk --create-namespace -f values-pump.yaml --devel

## Uninstalling the Chart

```bash
helm uninstall tyk-pump -n tyk
```
This removes all the Kubernetes components associated with the chart and deletes the release.

## Upgrading Chart

```bash
helm upgrade tyk-pump tyk-helm/tyk-pump -n tyk --devel
```

### Upgrading from tyk-headless chart
Please see Migration notes in [tyk-oss](https://github.com/TykTechnologies/tyk-charts/tree/main/tyk-oss) chart

## Configuration
See [Customizing the Chart Before Installing](https://helm.sh/docs/intro/using_helm/#customizing-the-chart-before-installing). To get all configurable options with detailed comments:

```bash
helm show values tyk-helm/tyk-pump > values.yaml --devel
```
You can update any value in your local values.yaml file and use `-f [filename]` flag to override default values during installation. Alternatively, you can use `--set` flag to set it in Tyk installation.

### Set Redis connection details (Required)
Redis is Tyk Pump's primary database where it scrapes Tyk Gateway analytics from. 
You may set `global.redis.addr` and `global.redis.pass` with redis connection string and password for Tyk Gateway respectively.

### Pump Configurations

| Pump                      | Configuration                                                                                              |
|---------------------------|------------------------------------------------------------------------------------------------------------| 
| Prometheus Pump (Default) | Add `prometheus` to `pump.backend`, and add connection details for prometheus under `pump.prometheusPump`. |
| Mongo Pump                | Add `mongo` to `pump.backend`, and add connection details for mongo under `.global.mongo`.                 |
| SQL Pump                  | Add `postgres` to `.pump.backend`, and add connection details for postgres under `.global.postgres`.       |
| Uptime Pump               | Set `pump.uptimePumpBackend` to `'mongo'` or `'postgres'` or `''`                                          |
| Hybrid Pump               | Add `hybrid` to `.pump.backend`, and setup `.global.remoteControlPlane` section with the required adresses and tokens           |
| Other Pumps               | Add the required environment variables in `pump.extraEnvs`                                                 |

#### Prometheus Pump
Add `prometheus` to `pump.backend`, and add connection details for prometheus under `pump.prometheusPump`. 

We also support monitoring using Prometheus Operator. All you have to do is set `pump.prometheusPump.prometheusOperator.enabled` to true.
This will create a PodMonitor resource for your Pump instance.

#### Mongo Pump
If you are using the MongoDB pumps in the tyk-oss installation you will require MongoDB installed for that as well.

To install Mongo you can use these rather excellent charts provided by Bitnami:

```bash
helm install tyk-mongo bitnami/mongodb --version {HELM_CHART_VERSION} --set "replicaSet.enabled=true" -n tyk
```

(follow notes from the installation output to get connection details and update them in `values.yaml` file)

NOTE: [Here is](https://tyk.io/docs/planning-for-production/database-settings/) list of supported MongoDB versions. Please make sure you are installing mongo helm chart that matches these version.

*Important Note regarding MongoDB:* This helm chart enables the PodDisruptionBudget for MongoDB with an arbiter replica-count of 1. If you intend to perform system maintenance on the node where the MongoDB pod is running and this maintenance requires for the node to be drained, this action will be prevented due the replica count being 1. Increase the replica count in the helm chart deployment to a minimum of 2 to remedy this issue.


Add following under the `global` section in `values.yaml`:

```yaml
   # Set mongo connection details if you want to configure mongo pump.     
   mongo:
      # The mongoURL value will allow you to set your MongoDB address.
      # Default value: mongodb://mongo.{{ .Release.Namespace }}.svc.cluster.local:27017/tyk_analytics
      # mongoURL: mongodb://mongo.tyk.svc.cluster.local:27017/tyk_analytics
      # If your MongoDB has a password you can add the username and password to the url
      # mongoURL: mongodb://root:pass@tyk-mongo-mongodb.tyk.svc.cluster.local:27017/tyk_analytics?authSource=admin
      mongoURL: <MongoDB address>

      # Enables SSL for MongoDB connection. MongoDB instance will have to support that.
      # Default value: false
      # useSSL: false
```

#### SQL Pump
If you are using the SQL pumps in the tyk-oss installation you will require PostgreSQL installed for that as well.

To install PostgreSQL you can use these rather excellent charts provided by Bitnami:

```bash
helm install tyk-postgres bitnami/postgresql --set "auth.database=tyk_analytics" -n tyk
```

(follow notes from the installation output to get connection details and update them in `values.yaml` file)

Add following under the `global` section in `values.yaml`:

```yaml
  # Set postgres connection details if you want to configure postgres pump.
  # Postgres connection string parameters.
  postgres:
      host: tyk-postgres-postgresql.tyk.svc.cluster.local
      port: 5432
      user: postgres
      password:
      database: tyk_analytics
      sslmode: disable
```

#### Uptime Pump
Uptime Pump can be configured by setting `pump.uptimePumpBackend` in values.yaml file. It supports following values
1. mongo: Used to set mongo pump for uptime analytics. Mongo Pump should be enabled.
2. postgres: Used to set postgres pump for uptime analytics. Postgres Pump should be enabled.
3. empty: Used to disable uptime analytics.

#### Hybrid Pump

```yaml
  # Set remoteControlPlane connection details if you want to configure hybrid pump.
  remoteControlPlane:
      # connection string used to connect to an MDCB deployment. For Tyk Cloud users, you can get it from Tyk Cloud Console and retrieve the MDCB connection string.
      connectionString: ""
      # orgID of your dashboard user
      orgId: ""
      # API key of your dashboard user
      userApiKey: ""
      # needed in case you want to have multiple data-planes connected to the same redis instance
      groupID: ""
      # enable/disable ssl
      useSSL: true
      # Disables SSL certificate verification
      sslInsecureSkipVerify: true
```

```yaml
  # hybridPump configures Tyk Pump to forward Tyk metrics to a Tyk Control Plane.
  # Please add "hybrid" to .Values.pump.backend in order to enable Hybrid Pump.
  hybridPump: 
    # Specify the frequency of the aggregation in minutes or simply turn it on by setting it to true
    enableAggregateAnalytics: true
    # Hybrid pump RPC calls timeout in seconds. If not specified, default value will be picked up by Tyk Pump.
    callTimeout: 10
    # Hybrid pump connection pool size. If not specified, default value will be picked up by Tyk Pump.
    poolSize: 5
```

#### Other Pumps
To set up other backends for pump, refer to this [document](https://github.com/TykTechnologies/tyk-pump/blob/master/README.md#pumps--back-ends-supported) and add the required environment variables in `pump.extraEnvs`

